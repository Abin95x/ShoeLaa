<%- include("./layout/adminHeader.ejs") %>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        border: 1px solid #dddddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }
</style>


<div class="screen-overlay"></div>
<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
        <a href="/admin/home" class="brand-wrap">
            <h3>ADMIN</h3>
        </a>
        <div>
            <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
        </div>
    </div>
    <nav>
        <ul class="menu-aside">
            <li class="menu-item active">
                <a class="menu-link" href="/admin/home">
                    <i class="icon material-icons md-home"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li class="menu-item has-submenu">
                <a class="menu-link" href="page-products-list.html">
                    <i class="icon material-icons md-shopping_bag"></i>
                    <span class="text">Products</span>
                </a>
                <div class="submenu">
                    <a href="/admin/productAdd"> Product Add</a>
                    <a href="/admin/productList"> Products List</a>
                    <a href="/admin/categoryManagement">Categories</a>
                </div>
            </li>
            <li class="menu-item has-submenu">
                <a class="menu-link" href="#">
                    <i class="icon material-icons md-person"></i>
                    <span class="text">User</span>
                </a>
                <div class="submenu">
                    <a href="/admin/userManage">User management</a>
                    <a href="#">Error 404</a>
                </div>
            </li>
            
            <li class="menu-item has-submenu">
                <a class="menu-link" href="page-orders-1.html">
                    <i class="icon material-icons md-shopping_cart"></i>
                    <span class="text">Orders</span>
                </a>
                <div class="submenu">
                    
                    <a href="/admin/orderUpdate">Order details</a>

                </div>
            </li>
            <li class="menu-item has-submenu">
                <a class="menu-link" href="page-transactions-1.html">
                    <i class="icon material-icons md-local_offer"></i>
                    <span class="text">Coupon</span>
                </a>
                <div class="submenu">
                    <a href="/admin/coupon">Coupon Add</a>
                    <a href="/admin/couponList">Coupon List</a>
                </div>
            </li>

            <li class="menu-item has-submenu">
                <a class="menu-link" href="page-transactions-1.html">
                    <i class="icon material-icons md-comment"></i>
                    <span class="text">Banner</span>
                </a>
                <div class="submenu">
                    <a href="/admin/bannerAdd">Banner Add</a>
                    <a href="/admin/bannerList">Banner List</a> 
                </div>
            </li>
        </ul>
        <br />
        <br />
    </nav>
</aside>
<main class="main-wrap">
    <header class="main-header navbar">
        <div class="col-search">
            <form class="searchform">  
                <datalist id="search_terms">
                    <option value="Products"></option>
                    <option value="New orders"></option>
                    <option value="Apple iphone"></option>
                    <option value="Ahmed Hassan"></option>
                </datalist>
            </form>
        </div>
        <div class="col-nav">
            <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside"><i class="material-icons md-apps"></i></button>
            <ul class="nav">
                
                <li class="nav-item">
                    <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                </li>
                
                
                <li class="dropdown nav-item">
                    <a class="dropdown-toggle" data-bs-toggle="dropdown" href="#" id="dropdownAccount" aria-expanded="false">admin</a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                       
                        <a class="dropdown-item text-danger" href="/admin/logout"><i class="material-icons md-exit_to_app"></i>Logout</a>
                    </div>
                </li>
            </ul>
        </div>
    </header>
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Dashboard</h2>
                <p>Whole data about your business here</p>
            </div>
            
        </div>
        <div class="row">
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-primary-light"><i class="text-primary material-icons md-monetization_on"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Total Revenue</h6>
                            <span>₹<%= totalRevenue[0].revenue %></span>
                            <span class="text-sm"> </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <articchart1le class="icontext">
                        <span class="icon icon-sm rounded-circle bg-success-light"><i class="text-success material-icons md-local_shipping"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Orders</h6>
                            <span> <%= orderCount %></p>    </span>
                            <span class="text-sm"> Excluding orders in transit </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-warning-light"><i class="text-warning material-icons md-qr_code"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Products</h6>
                            <span><%= productsCount %></span>
                            <span class="text-sm"> In <%= categoryCount %> Categories </span>
                        </div>
                    </article>
                </div>
            </div>
            <div class="col-lg-3">
                <div class="card card-body mb-4">
                    <article class="icontext">
                        <span class="icon icon-sm rounded-circle bg-info-light"><i class="text-info material-icons md-shopping_basket"></i></span>
                        <div class="text">
                            <h6 class="mb-1 card-title">Weekly Earning</h6>
                            <span>₹ <%= currentWeekRevenue[0].revenue %></span>
                            <span class="text-sm">from <%=currentWeekRevenue[0].count %> Orders</span>
                            <span class="text-sm"> Based in your local time. </span>
                        </div>
                    </article>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-8 col-lg-12">
                <div class="card mb-4">
                    <article class="card-body">
                        <h5 class="card-title">Sale statistics</h5>
                        <canvas id="myChart" height="120px"></canvas>
                    </article>
                </div>
                
            </div>
          
            <div class="col-xl-4 col-lg-12">
                <div class="card mb-4">
                    <article class="card-body">
                        <h5 class="card-title">Status</h5>
                        <div id="chart1"></div>
                    </article>
                </div>
               
            </div>
        </div>
        <div class="card mb-4">
        <header class="card-header">
            <span>
                <h4 class="card-title">Sales Report - Delivered orders</h4>
            </span>
        </header>
        <% if (orders.length === 0) { %>
            <h4 style="text-align: center;">No Orders</h4>
        <% } else { %>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="printThisDiv" class="table align-middle table-nowrap mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="align-middle" scope="col">No</th>
                                <th class="align-middle" scope="col"> Order ID </th>
                                <th class="align-middle" scope="col"> Date </th>
                                <th class="align-middle" scope="col">Name </th>
                                <!-- <th class="align-middle" scope="col">Coupon </th> -->

                                <th class="align-middle" scope="col"> Product Price </th>

                                <th class="align-middle" scope="col"> Total </th>
                                <th class="align-middle" scope="col">Payment Method </th>
                                <th class="align-middle" scope="col"> Status </th>
                            </tr>
                        </thead>
                        <tbody>
                            <% const deliveredOrders = orders.filter(order => order.products.some(item => item.status === "Delivered")); %>
                            <% if (deliveredOrders.length === 0) { %>
                                <tr>
                                    <td colspan="7" style="text-align: center;">No Delivered Orders</td>
                                </tr>
                            <% } else { %>
                                <% let orderNumber = 1; %>
                                <% deliveredOrders.forEach(order => { %>
                                    <% order.products.forEach(item => { %>
                                        <% if (item.status === "Delivered") { %>
                                            <tr>
                                                <td class="text-center">
                                                    <div class="form-check">
                                                        <%= orderNumber %>:
                                                    </div>
                                                </td>
                                                <td><a href="#" class="fw-bold"> <%= order._id %> </a></td>
                                                <td> <%= moment(order.date).format('YYYY-MM-DD') %></td> 
                                                <td> <%= order.userName %> </td>
                                                <td> <%= item.totalPrice %> </td>

                                                <td> <%= order.totalAmount %> </td>
                                                <td> <%= order.payment %> </td>
                                                <td> <%= item.status %> </td>
                                            </tr>
                                            <% orderNumber++; %>
                                        <% } %>
                                    <% }); %>
                                <% }); %>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        <% } %>
        </div>
       
        <div>
            <!-- <button
            type="button"
            onclick="printDiv('printThisDiv')"
            class="btn btn-primary mt-3">Download PDF 
        </button> -->
        <div class="col-lg-6 text-lg-end">
            <button type="button" onclick="generateExcel()" class="btn btn-primary mt-4">
              Excel 
            </button>
            <button type="button" onclick="generatePDF()" class="btn btn-primary mt-4">
              PDF 
            </button>
          </div>
        </div>
          
        
        
    </section>
    <input type="hidden" id="jan" value="<%=salesData[0]%>" />
    <input type="hidden" id="feb" value="<%=salesData[1]%>" />
    <input type="hidden" id="mar" value="<%=salesData[2]%>" />
    <input type="hidden" id="apr" value="<%=salesData[3]%>" />
    <input type="hidden" id="may" value="<%=salesData[4]%>" />
    <input type="hidden" id="jun" value="<%=salesData[5]%>" />
    <input type="hidden" id="jul" value="<%=salesData[6]%>" />
    <input type="hidden" id="aug" value="<%=salesData[7]%>" />
    <input type="hidden" id="sep" value="<%=salesData[8]%>" />
    <input type="hidden" id="oct" value="<%=salesData[9]%>" />
    <input type="hidden" id="nov" value="<%=salesData[10]%>" />
    <input type="hidden" id="dec" value="<%=salesData[11]%>" />
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="assets/js/vendors/select2.min.js"></script>
<script src="assets/js/vendors/perfect-scrollbar.js"></script>
<script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
<script src="assets/js/vendors/chart.js"></script>
<!-- Main Script -->
<script src="assets/js/main.js?v=1.1" type="text/javascript"></script>
<script src="assets/js/custom-chart.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<!-- sales report download -->
<script>
    function generatePDF() {
        const orders = document.querySelectorAll('.table tbody tr');
        const orderRows = [];

        orders.forEach(order => {
            const No = order.cells[0].innerText;
            const Id = order.cells[1].innerText;
            const Date = order.cells[2].innerText;
            const Name = order.cells[3].innerText;
            const Total = order.cells[4].innerText; // Changed index to match table structure
            const Payment_Method = order.cells[5].innerText;
            const Status = order.cells[6].innerText;

            orderRows.push([No, Id, Date, Name, Total, Payment_Method, Status]);
        });

        const pdfFormat = {
            content: [
                { text: 'Shoe Laa Sales Report', style: 'header' },
                {
                    table: {
                        headerRows: 1,
                        widths: [20, 100, 100, 50, 45, 30, 50, 80],
                        body: [['No', 'Id', 'Date', 'Name', 'Total', 'Payment_Method', 'Status'], ...orderRows]
                    }
                }
            ],
            styles: {
                header: {
                    fontSize: 20,
                    bold: true,
                    alignment: 'center',
                    margin: [0, 0, 0, 10]
                }
            }
        };

        pdfMake.createPdf(pdfFormat).print();
    }

    // Excel Download
    function generateExcel() {
        const orders = document.querySelectorAll('.table tbody tr');
        const orderData = [];

        orders.forEach(order => {
            const No = order.cells[0].innerText;
            const Id = order.cells[1].innerText;
            const Product = order.cells[2].innerText;
            const Price = order.cells[3].innerText;
            const Payment_Method = order.cells[4].innerText;
            const Total = order.cells[5].innerText;
            const Date = order.cells[6].innerText;

            orderData.push([No, Id, Product, Price, Payment_Method, Total, Date]);
        });

        const header = ['No', 'Id', 'Product', 'Price', 'Payment_Method', 'Total', 'Date'];
        const data = [header, ...orderData];

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Sales Report');

        // Generating filename based on the current date and time
        const filename = 'Sales_Report_' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.xlsx';

        // Convert the workbook to a binary Excel file and trigger the download
        XLSX.writeFile(wb, filename);
    }
</script>
<script>
    var placedCount = parseInt("<%= placedCount %>");
    var deliveredCount = parseInt("<%= deliveredCount %>");
    var cancelledCount = parseInt("<%= cancelledCount %>");
    var returnedCount = parseInt("<%= returnedCount %>")


      
    var options = {
          series: [deliveredCount, placedCount, returnedCount, cancelledCount],
          chart: {
          width: 300,
          type: 'pie',
        },
        labels: ['Delivered', 'Placed', 'Returned' , 'Cancelled'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }]
        };

        var chart = new ApexCharts(document.querySelector("#chart1"), options);
        chart.render();  
    
</script>
<script>
    function printDiv(divName) {
      const printContents = document.getElementById(divName).innerHTML;
      const originalContents = document.body.innerHTML;
      document.body.innerHTML = printContents;
      window.print();
      document.body.innerHTML = originalContents;
    }
  </script>

<%- include("./layout/adminFooter.ejs") %>